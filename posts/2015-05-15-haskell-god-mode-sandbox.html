<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Haskell "God Mode" Sandbox</title>
    <link rel="stylesheet" type="text/css" href="../css/bootstrap-readable.min.css" />
    <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="../css/default.css" />
    <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
    <link rel="stylesheet" type="text/css" href="//vjs.zencdn.net/4.12/video-js.css" />

    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
    </script>
  </head>
  <body>
    <div class="container">
      <div class="header row">
        <h3><a class="text-muted col-sm-8" href="../">begriffs</a></h3>

        <ul class="col-sm-4 list-inline">
          <li><a class="text-muted" href="../about.html"><i class="fa fa-info-circle"></i></a></li>
          <li><a class="text-muted" href="http://github.com/begriffs"><i class="fa fa-github"></i></a></li>
          <li><a class="text-muted" href="http://twitter.com/begriffs"><i class="fa fa-twitter"></i></a></li>
          <li><a class="text-muted" href="../atom.xml"><i class="fa fa-rss"></i></a></li>
        </ul>
      </div>

      <div class="post-header">
  <h3>Haskell "God Mode" Sandbox</h3>
  <a href="https://twitter.com/share" class="twitter-share-button pull-right" data-via="begriffs" data-count="none">Tweet</a>
  <h5 class="text-muted">May 15, 2015</h5>
</div>

<div class="content">
  <p>Sandboxes have abolished cabal hell but in many cases have introduced long redundant compilation (looking at you, <code>haskell-src-exts</code> and <code>lens</code>). Recently I’ve given <a href="https://www.stackage.org/">Stackage</a> a try to share a common sandbox between projects while pinning compatible package versions.</p>
<p>Stackage has worked great, but I thought of a way to get even crazier with it: preemptively <strong>build all of hackage</strong> into a huge shared sandbox pinned to a given Stackage LTS version. This would take forever, right? Yep, it did. Over a week on my Mac running around the clock. But now that it’s done virtually any haskell project builds on my machine immediately without having to build its dependencies.</p>
<p>If you’re also using OS X 10.10, GHC 7.8 and Stackage LTS 2.5 then you can get the speed too without having to turn your computer into a space heater:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">mkdir</span> -p ~/.stackage
<span class="kw">curl</span> http://bin.begriffs.com/godmode/osx-10.10_ghc-7.8.4_stackage-lts-2.5.tar.xz <span class="kw">|</span> <span class="kw">tar</span> xJ -C ~/.stackage
<span class="co"># it's about 800MB</span></code></pre></div>
<p>Next install <a href="https://hackage.haskell.org/package/stackage-cli">stackage-cli</a>. Then, inside any project you’d like to build run</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">stackage</span> sandbox init lts-2.5</code></pre></div>
<p>Building the project will use the sandbox and be fast. If <code>cabal install</code> hangs on resolving resources, try the flag <code>--solver=topdown</code> which uses more memory but appears to get past that problem.</p>
<h3 id="creating-a-new-megasandbox">Creating a new megasandbox</h3>
<div class="alert alert-warning" role="alert">
<h4>
Security Warning
</h4>
<p>Haskell package builds can run arbitrary code. You probably do not want to build all packages on hackage right on your personal computer. Use an isolated environment instead like CI or a virtual machine so that your data is not exposed to random code on the internet.</p>
</div>
<p>To build god mode for another architecture you need to get the list of all packages on hackage and xargs it into cabal. Here’s my hacky little solution:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">npm</span> install -g json
<span class="kw">mkdir</span> -d /tmp/build <span class="kw">&amp;&amp;</span> <span class="kw">cd</span> <span class="ot">$_</span>
<span class="kw">cabal</span> sandbox init
<span class="kw">wget</span> https://www.stackage.org/snapshot/lts-2.5/cabal.config
<span class="kw">curl</span> -H <span class="st">&quot;Accept: application/json&quot;</span> https://hackage.haskell.org/packages/ <span class="kw">|</span> <span class="kw">\</span>
  <span class="kw">json</span> <span class="kw">|</span> <span class="kw">grep</span> packageName <span class="kw">|</span> <span class="kw">cut</span> -f 4 -d <span class="st">'&quot;'</span> <span class="kw">|</span> <span class="kw">\</span>
  <span class="kw">xargs</span> -L 1 cabal install -j --disable-documentation --max-backjumps=10

<span class="co"># Clean the executables themselves (they're big!)</span>
<span class="kw">rm</span> ~/.stackage/ghc-7.8.4/lts-2.5/bin/*</code></pre></div>
<p>Note that the first packages in the list begin with capital letters and these packages are mostly old and bogus. You could remove them from the list with <code>grep ^[a-z]</code> without doing too much harm because the useful capital letter packages will end up being included by other packages.</p>
<p>Some packages failed to build on my machine because certain specialized C libraries were missing. That’s OK by me since it built all the general purpose packages. Also the <code>max-backjumps</code> was important because otherwise cabal would freeze on certain packages as the sandbox got big. The magic number is open to experimentation. I think it did cause some packages to fail when they shouldn’t have.</p>
<h3 id="automation">Automation?</h3>
<p>CircleCI now supports <a href="https://circleci.com/docs/ios">OS X builds</a> in addition to Linux. We could use it to do the builds for new Stackage LTS versions as they are released. Have Circle run the build, compress the folder, and deploy to S3.</p>
<p>Having full prebuilt Stackage sandboxes available across platforms could help make Haskell development faster and more fun for everybody.</p>
</div>

    </div>

    <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="//vjs.zencdn.net/4.12/video.js"></script>
    <!-- Aww yiss, obsessively watching my numbers! -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-49573102-1', 'begriffs.com');
      ga('send', 'pageview');
    </script>

    <footer class="container">
      <p>I'm begriffs, journeying from web ephemera to the timeless world of data. <a href="mailto:joe@begriffs.com" role="button">Contact me.</a></p>
    </footer>
  </body>
</html>
