<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <title>Creating a package on Hackage</title>
    <link rel="stylesheet" type="text/css" href="../css/bootstrap-readable.min.css" />
    <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="../css/default.css" />
    <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
    <link rel="stylesheet" type="text/css" href="//vjs.zencdn.net/4.12/video-js.css" />

    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
    </script>
  </head>
  <body>
    <div class="container">
      <div class="header row">
        <h3><a class="text-muted col-sm-8" href="../">begriffs</a></h3>

        <ul class="col-sm-4 list-inline">
          <li><a class="text-muted" href="../about.html"><i class="fa fa-info-circle"></i></a></li>
          <li><a class="text-muted" href="http://github.com/begriffs"><i class="fa fa-github"></i></a></li>
          <li><a class="text-muted" href="http://twitter.com/begriffs"><i class="fa fa-twitter"></i></a></li>
          <li><a class="text-muted" href="../atom.xml"><i class="fa fa-rss"></i></a></li>
        </ul>
      </div>

      <div class="post-header">
  <h3>Creating a package on Hackage</h3>
  <a href="https://twitter.com/share" class="twitter-share-button pull-right" data-via="begriffs" data-count="none">Tweet</a>
  <h5 class="text-muted">October 25, 2014</h5>
</div>

<div class="content">
  <p>How do you go from a pile of Haskell code on your machine to a finished package on <a href="http://hackage.haskell.org">Hackage</a> in all its tactfully understated glory? I recently took this journey and some of the steps were tricky enough that I thought someone ought to write a guide.</p>
<h3 id="step-1---the-account">Step 1 - the account</h3>
<p><a href="http://hackage.haskell.org/users/register-request">Register</a> a user account. Like many steps in Hackage, this is a somewhat human and manual process. A person has to review your submission and deem you worthy. So I guess don’t pick a profile name like <code>javascriptFTW</code> that would anger them.</p>
<h3 id="step-2---package-structure">Step 2 - package structure</h3>
<p>Structure your package in a standard way. Source directories are nested and named after the exposed module path. Your test suite lives in its own place and needs some boilerplate configuration. And of course you’ll need a good cabal file. <em>Want the shortcut?</em> Run <a href="https://github.com/fujimura/hi">fujimura/hi</a> to generate your project structure. By default it will choose a BSD license and use <code>hspec</code> for tests. Speaking for myself I changed it to an MIT license and <a href="http://hackage.haskell.org/package/hspec2">hspec2</a>.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">hi</span> --module-name <span class="st">&quot;Foo.Bar.Baz&quot;</span> --author <span class="st">&quot;J Doe&quot;</span> --email <span class="st">&quot;jdoe@me.com&quot;</span></code></pre></div>
<h3 id="step-3---cabal">Step 3 - cabal</h3>
<p>Customize the package cabal file. If you’re wondering whether it includes enough information, check with</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">cabal</span> check</code></pre></div>
<p>which will point out any problems. In fact Hackage will refuse a package upload that fails the check. However there are fields you might like to add beyond the bare minimum, such as the <code>Homepage</code> field with a link to the project on Github. See this <a href="http://www.haskell.org/ghc/docs/7.0.3/html/Cabal/authors.html#general-fields">reference</a> of all the fields.</p>
<h3 id="step-4---docs">Step 4 - docs</h3>
<p>Add Haddock documentation to your code as comments. There is more to Haddock than can reasonably fit in a little guide like this, but a good way to go is copy what people do in a popular package you admire. Generally the structure of generated docs is determined in your module declaration. Be sure to include some example code since it gives a quick overview to would-be users.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">module</span> <span class="dt">Foo.Bar.Baz</span>
  (
    <span class="co">-- * Example usage</span>
    <span class="co">-- $use</span>

    <span class="co">-- * A section</span>
    <span class="dt">Thingie</span>(<span class="fu">..</span>)

    <span class="co">-- * More stuff</span>
  , fun
  , joy
  ) <span class="kw">where</span></code></pre></div>
<p>Notice you can create chunks by name like <code>$use</code> and interpolate them at the right place in the module declaration. To preview your docs locally run</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">cabal</span> haddock</code></pre></div>
<p>which will build the docs in <code>dist/doc/html/your-pkg/index.html</code>. Note that unlike the custom in other languages, Haskellers usually don’t put much info into READMEs. At first I thought they were being negligent but I learned that the combination of strong types and Haddock’s structure provide a standardized documentation experience that works better. I like to add a link in my Github readme to point at the Hackage docs to help those unfamiliar with the convention.</p>
<h3 id="step-5---ci">Step 5 - CI</h3>
<p>Enable continuous integration. You want to ensure that</p>
<ul>
<li>your usual tests pass</li>
<li>your project works in a few versions of GHC</li>
<li>your cabal file is well-formed</li>
<li>a source distribution can be generated</li>
<li>docs build cleanly</li>
</ul>
<p>Here’s a nice Travis config adapted from <a href="https://twitter.com/bitemyapp">bitemyapp</a> who got it from <a href="https://github.com/hvr">hvr</a>.</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">language:</span> haskell

<span class="fu">ghc:</span>
 <span class="kw">-</span> 7.6
 <span class="kw">-</span> 7.8

<span class="fu">before_install:</span>
 <span class="kw">-</span> <span class="fu">sudo add-apt-repository -y ppa:</span>hvr/ghc
 <span class="kw">-</span> sudo apt-get update
 <span class="kw">-</span> sudo apt-get install happy-1.19.3
 <span class="kw">-</span> sudo apt-get install alex-3.1.3
 <span class="kw">-</span> <span class="fu">export PATH=~/.cabal/bin:</span>$PATH <span class="co"># for newer alex</span>
 <span class="kw">-</span> cabal update
 <span class="kw">-</span> cabal install alex happy

<span class="fu">install:</span>
 <span class="kw">-</span> cabal install --only-dependencies --enable-tests --enable-benchmarks --force-reinstalls

<span class="fu">script:</span>
 <span class="co"># -v2 provides useful information for debugging</span>
 <span class="kw">-</span> cabal configure --enable-tests --enable-benchmarks -v2

 <span class="co"># this builds all libraries and executables</span>
 <span class="co"># (including tests/benchmarks)</span>
 <span class="kw">-</span> cabal build

 <span class="kw">-</span> cabal test
 <span class="kw">-</span> cabal check

 <span class="co"># tests that a source-distribution can be generated</span>
 <span class="kw">-</span> cabal sdist

 <span class="co"># check that the generated source-distribution can be built &amp; installed</span>
 <span class="kw">-</span> export SRC_TGZ=$(cabal info . | awk <span class="st">'{print $2 &quot;.tar.gz&quot;;exit}'</span>) ;
   cd dist/;
   if <span class="kw">[</span> -f <span class="st">&quot;$SRC_TGZ&quot;</span> <span class="kw">]</span>; then
      cabal install <span class="st">&quot;$SRC_TGZ&quot;</span>;
   else
      echo <span class="st">&quot;expected '$SRC_TGZ' not found&quot;</span>;
      exit 1;
   fi</code></pre></div>
<h3 id="step-6---dependencies">Step 6 - dependencies</h3>
<p>Add some constraints to your library’s dependencies in the cabal file. Locking major versions of dependencies will help prevent surprise Cabal build failures by your users. This is about the only rule of thumb I know. Setting constraints more intelligently is certainly possible, and I welcome your comments about your own strategies.</p>
<h3 id="step-7---candidate-package">Step 7 - candidate package</h3>
<p>Your tests pass, your docs look good. It’s time to upload a “package candidate” for a last check that things are OK on the real Hackage.</p>
<p>Create a source distribution</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">cabal</span> sdist</code></pre></div>
<p>This will generate <code>dist/your-pkg-x.y.z.tar.gz</code>. Select this file in the <a href="https://hackage.haskell.org/packages/candidates/upload">candidate uploader</a> and give it a go.</p>
<h3 id="step-8---release-it">Step 8 - release it</h3>
<p>Some people like to leave their packages as candidates for a while to find bugs etc. The quality on hackage is generally pretty high so you want to avoid throwing things up there half-baked. Generally if you’ve followed the previous steps you should be in pretty good shape to release your package for real though.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">cabal</span> upload dist/your-pkg-x.y.z.tar.gz</code></pre></div>
<p>All done, right? Time to celebrate! Not necessarily. Recently Hackage has been failing to run haddock remotely to generate documentation. The maintainers claim there is a small delay but I have found sometimes it never happens. Thankfully <a href="https://twitter.com/kmett">Edward Kmett</a> created a script to build your own docs and push them to Hackage.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co">#!/bin/bash</span>
<span class="kw">set</span> <span class="kw">-e</span>

<span class="kw">if [</span> <span class="st">&quot;</span><span class="ot">$#</span><span class="st">&quot;</span> <span class="ot">-ne</span> 1<span class="kw"> ]</span>; <span class="kw">then</span>
  <span class="kw">echo</span> <span class="st">&quot;Usage: scripts/hackage-docs.sh HACKAGE_USER&quot;</span>
  <span class="kw">exit</span> 1
<span class="kw">fi</span>

<span class="ot">user=$1</span>

<span class="ot">cabal_file=$(</span><span class="kw">find</span> . -maxdepth 1 -name <span class="st">&quot;*.cabal&quot;</span> -print -quit<span class="ot">)</span>
<span class="kw">if [</span> <span class="ot">!</span> <span class="ot">-f</span> <span class="st">&quot;</span><span class="ot">$cabal_file</span><span class="st">&quot;</span><span class="kw"> ]</span>; <span class="kw">then</span>
  <span class="kw">echo</span> <span class="st">&quot;Run this script in the top-level package directory&quot;</span>
  <span class="kw">exit</span> 1
<span class="kw">fi</span>

<span class="ot">pkg=$(</span><span class="kw">awk</span> -F <span class="st">&quot;:[[:space:]]*&quot;</span> <span class="st">'tolower($1)==&quot;name&quot;    { print $2 }'</span> <span class="kw">&lt;</span> <span class="st">&quot;</span><span class="ot">$cabal_file</span><span class="st">&quot;</span><span class="ot">)</span>
<span class="ot">ver=$(</span><span class="kw">awk</span> -F <span class="st">&quot;:[[:space:]]*&quot;</span> <span class="st">'tolower($1)==&quot;version&quot; { print $2 }'</span> <span class="kw">&lt;</span> <span class="st">&quot;</span><span class="ot">$cabal_file</span><span class="st">&quot;</span><span class="ot">)</span>

<span class="kw">if [</span> <span class="ot">-z</span> <span class="st">&quot;</span><span class="ot">$pkg</span><span class="st">&quot;</span><span class="kw"> ]</span>; <span class="kw">then</span>
  <span class="kw">echo</span> <span class="st">&quot;Unable to determine package name&quot;</span>
  <span class="kw">exit</span> 1
<span class="kw">fi</span>

<span class="kw">if [</span> <span class="ot">-z</span> <span class="st">&quot;</span><span class="ot">$ver</span><span class="st">&quot;</span><span class="kw"> ]</span>; <span class="kw">then</span>
  <span class="kw">echo</span> <span class="st">&quot;Unable to determine package version&quot;</span>
  <span class="kw">exit</span> 1
<span class="kw">fi</span>

<span class="kw">echo</span> <span class="st">&quot;Detected package: </span><span class="ot">$pkg</span><span class="st">-</span><span class="ot">$ver</span><span class="st">&quot;</span>

<span class="ot">dir=$(</span><span class="kw">mktemp</span> -d build-docs.XXXXXX<span class="ot">)</span>
<span class="kw">trap</span> <span class="st">'rm -r &quot;$dir&quot;'</span> EXIT

<span class="kw">cabal</span> haddock --hoogle --hyperlink-source --html-location=<span class="st">'/package/$pkg-$version/docs'</span> --contents-location=<span class="st">'/package/$pkg-$version'</span>

<span class="kw">cp</span> -R dist/doc/html/<span class="ot">$pkg</span>/ <span class="ot">$dir</span>/<span class="ot">$pkg</span>-<span class="ot">$ver</span>-docs

<span class="kw">tar</span> cvz -C <span class="ot">$dir</span> --format=ustar -f <span class="ot">$dir</span>/<span class="ot">$pkg</span>-<span class="ot">$ver</span>-docs.tar.gz <span class="ot">$pkg</span>-<span class="ot">$ver</span>-docs

<span class="kw">curl</span> -X PUT \
     -H <span class="st">'Content-Type: application/x-tar'</span> \
     -H <span class="st">'Content-Encoding: gzip'</span> \
     -u <span class="st">&quot;</span><span class="ot">$user</span><span class="st">&quot;</span> \
     --data-binary <span class="st">&quot;@</span><span class="ot">$dir</span><span class="st">/</span><span class="ot">$pkg</span><span class="st">-</span><span class="ot">$ver</span><span class="st">-docs.tar.gz&quot;</span> \
     <span class="st">&quot;https://hackage.haskell.org/package/</span><span class="ot">$pkg</span><span class="st">-</span><span class="ot">$ver</span><span class="st">/docs&quot;</span></code></pre></div>
<p>Now you will have published a package that looks good and will be be easy for people to use. So get that code off your computer and onto Hackage and contribute to the glorious Haskell ecosystem!</p>
</div>

    </div>

    <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="//vjs.zencdn.net/4.12/video.js"></script>
    <!-- Aww yiss, obsessively watching my numbers! -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-49573102-1', 'begriffs.com');
      ga('send', 'pageview');
    </script>

    <footer class="container">
      <p>I'm begriffs, journeying from web ephemera to the timeless world of data. <a href="mailto:joe@begriffs.com" role="button">Contact me.</a></p>
    </footer>
  </body>
</html>
